version: '2'
###
services:
  #_____________________________________________________
  #
  base.testsuite:
    image: cubbles/base.testsuite:1.0
    links:
      - "base.gateway:gateway"
      - "base.authentication:authentication"
      - "base.userprofilemanagement:userprofilemanagement"
      - "base.webpackagesearch:webpackagesearch"
      - "base.coredatastore:coredatastore"
  #_____________________________________________________
  #
  base.gateway:
    image: cubbles/base.gateway:1.0
    environment:
      - NODEMON_OPTIONS=-e conf,locations,ssl --watch /opt/base/gateway
      - SSL_CERT=/opt/base/gateway/conf.d/cert/self_signed_server.crt
      - SSL_CERT_KEY=/opt/base/gateway/conf.d/cert/self_signed_server.key
      - SSL_CERT_WEBBLEBASENET=/opt/base/gateway/conf.d/cert/webblebase.net.test.crt
      - SSL_CERT_KEY_WEBBLEBASENET=/opt/base/gateway/conf.d/cert/webblebase.net.test.key
      - BASE_AUTH_SECRET=devBase#123!
    links:
      - "base.authentication:authentication"
      - "base.userprofilemanagement:userprofilemanagement"
      - "base.webpackagesearch:webpackagesearch"
      - "base.coredatastore:coredatastore"
    volumes_from:
      - base.serviceconfig:rw
  #_____________________________________________________
  #
  base.authentication:
    image: cubbles/base.authentication:1.0
    environment:
      - NODEMON_OPTIONS=--watch /opt/authentication/base-authentication-service/authentication-service.js --watch /opt/authentication/base-authentication-service/lib
      - BASE_AUTH_DATASTORE_URL=http://coredatastore:5984
      - BASE_AUTH_DATASTORE_ADMINCREDENTIALS=${BASE_AUTH_DATASTORE_ADMINCREDENTIALS}
    links:
      - "base.coredatastore:coredatastore"
    volumes_from:
      - base.serviceconfig:ro
  #_____________________________________________________
  #
  base.userprofilemanagement:
    image: cubbles/base.userprofilemanagement:1.0
    environment:
      - NODEMON_OPTIONS=--watch /opt/userprofilemanagement/base-userprofilemanagement-service/service.js --watch /opt/userprofilemanagement/base-userprofilemanagement-service/lib
      - BASE_AUTH_DATASTORE_URL=http://coredatastore:5984
      - BASE_AUTH_DATASTORE_ADMINCREDENTIALS=${BASE_AUTH_DATASTORE_ADMINCREDENTIALS}
    links:
      - "base.coredatastore:coredatastore"
    volumes_from:
      - base.serviceconfig:ro
  #_____________________________________________________
  #
  base.webpackagesearch:
    image: docker.webblebase.net:444/base/webpackagesearch:1.2
    links:
      - "base.coredatastore:coredatastore"
    volumes_from:
      - base.serviceconfig:ro
  #_____________________________________________________
  # serviceconfig: central configuration
  base.serviceconfig:
    image: cubbles/base.serviceconfig:1.0
  #_____________________________________________________
  #
  base.coredatastore:
    image: cubbles/base.coredatastore:1.0
    environment:
      - BASE_AUTH_DATASTORE_ADMINCREDENTIALS=${BASE_AUTH_DATASTORE_ADMINCREDENTIALS}
      - BASE_CLUSTER=${BASE_CLUSTER}
    volumes:
      - base.coredatastore_volume:/usr/local/var/lib/couchdb/

#========================================================
# volumes
# @see https://docs.docker.com/engine/userguide/containers/dockervolumes/
volumes:
  base.coredatastore_volume:

#
#========================================================
# networks