server {
    listen 80 default_server;
    server_name  _;
    include /opt/base/gateway/conf.d/base.ssl;

    # To find out, how nginx does request-proccessing: @see http://nginx.org/en/docs/http/request_processing.html
    ##############
    # purpose: show named store infos
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/[a-z0-9-]+/?$ {
        # cors related config
        add_header Access-Control-Allow-Headers "X-Requested-With";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Origin "*";

        # authentication
        limit_except GET HEAD {
            deny  all;
        }

        # proxy target
        rewrite ^/(.*)$ /webpackage-store-$1 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # purpose: allow webpackages access on a named store
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/[a-z0-9-]+/(_design|[a-z0-9]+)+ {
        # cors related config
        add_header Access-Control-Allow-Headers "X-Requested-With";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Origin "*";

        # authentication
        limit_except GET HEAD {
            deny  all;
        }

        # proxy target
        rewrite ^/(.*)$ /webpackage-store-$1 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # purpose: allow webpackage upload into a named store
    # - couchdb-api details
    #   see http://docs.couchdb.org/en/1.6.1/http-api.html
    #   see https://wiki.apache.org/couchdb/HTTP_Document_API#Multiple_Attachments
    location ~ /[a-z0-9-]+/(_api/upload) {
        # increase max file size from default=1mb
        # @see https://webbles.instajira.com/browse/PLAT-100
        client_max_body_size 2m;

        # CORS related config (esp. for development purposes, where your application is served e.g. from localhost)
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS, POST, PUT';

        # The handling of OPTIONS request is included esp. for use cross-domain usage of XMLHttpRequest
        # @see https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Preflighted_requests
        # CORS related config (esp. for development purposes, where your application is served e.g. from localhost)
        if ($request_method = OPTIONS ) {
            # test instructions:
            # $ curl -X OPTIONS http://boot2docker.me/{store}/_api/upload/000-uploadtest -v
            # the response should return the 'Access-Control-Allow-*' -Headers

            # Important: You need to set the headers here again - because of the behaviour of the if-directive
            #   @see http://wiki.nginx.org/IfIsEvil
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS, POST, PUT';
            #
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_upload-htpasswd;

        # proxy target
        rewrite ^/([a-z0-9-]+)/_api/upload(.*)$ /webpackage-store-$1$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    #############################
    ### deprecated: begin #######
    #############################
    # @deprecated
    # Will be removed, if modelVersion-7.* is outdated, as we switched to named stores with modelVersion-8.
    #
    # purpose: allow webpackage upload into the root store
    # - couchdb-api details
    #   see http://docs.couchdb.org/en/1.6.1/http-api.html
    #   see https://wiki.apache.org/couchdb/HTTP_Document_API#Multiple_Attachments
    location ~ /(_upload|_api/upload) {
        # increase max file size from default=1mb
        # @see https://webbles.instajira.com/browse/PLAT-100
        client_max_body_size 2m;

        # CORS related config (esp. for development purposes, where your application is served e.g. from localhost)
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS, POST, PUT';

        # The handling of OPTIONS request is included esp. for use cross-domain usage of XMLHttpRequest
        # @see https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Preflighted_requests
        # CORS related config (esp. for development purposes, where your application is served e.g. from localhost)
        if ($request_method = OPTIONS ) {
            # test instructions:
            # $ curl -X OPTIONS http://boot2docker.me/_api/upload/000-uploadtest -v
            # the response should return the 'Access-Control-Allow-*' -Headers

            # Important: You need to set the headers here again - because of the behaviour of the if-directive
            #   @see http://wiki.nginx.org/IfIsEvil
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Allow-Methods' 'GET, HEAD, OPTIONS, POST, PUT';
            #
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_upload-htpasswd;

        # proxy target
        rewrite ^/(_upload|_api/upload)(.*)$ /webpackage-store$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    #
    ###########################
    ### deprecated: end #######
    ###########################

    # purpose: allow replication of the database
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/[a-z0-9-]+/_api/replicate {
        # couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_replicate-htpasswd;

        # proxy target
        rewrite ^/([a-z0-9-]+)/_api/replicate/?$ /webpackage-store-$1 break;
        rewrite ^/([a-z0-9-]+)/_api/replicate/_changes$ /webpackage-store-$1/_changes break;
        rewrite ^/([a-z0-9-]+)/_api/replicate/_ensure_full_commit$ /webpackage-store-$1/_ensure_full_commit break;
        rewrite ^/([a-z0-9-]+)/_api/replicate(/.*)$ /webpackage-store-$1$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    #############################
    ### deprecated: begin #######
    #############################
    # @deprecated
    # Will be removed, if modelVersion-7.* is outdated, as we switched to named stores with modelVersion-8.
    #
    # purpose: allow replication of the database
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/(_replicate|_api/replicate) {
        # couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_replicate-htpasswd;

        # proxy target
        rewrite ^/(_replicate|_api/replicate)/?$ /webpackage-store break;
        rewrite ^/(_replicate|_api/replicate)/_changes$ /webpackage-store/_changes break;
        rewrite ^/(_replicate|_api/replicate)/_ensure_full_commit$ /webpackage-store/_ensure_full_commit break;
        rewrite ^/(_replicate|_api/replicate)(/.*)$ /webpackage-store$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    #
    ###########################
    ### deprecated: end #######
    ###########################

    #############################
    ### deprecated: begin #######
    #############################
    # @deprecated
    # Will be removed, if modelVersion-7.* is outdated, as we switched to the couchapp -based artifactsearch with modelVersion-8
    #
    # purpose: allow accessing webpackages directly
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ^~ /_api/webpackagesearch {
        # CORS
        #  note: LoopBack enables Cross-origin resource sharing (CORS).
        #  @see http://docs.strongloop.com/display/public/LB/Security+considerations#Securityconsiderations-CORS
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # limit access
        limit_except GET HEAD {
            deny  all;
        }
        # proxy target
        proxy_pass http://webpackagesearch:3000;
    }
    #
    ###########################
    ### deprecated: end #######
    ###########################


    #############################
    ### deprecated: begin #######
    #############################
    # @deprecated
    # Will be removed, if modelVersion-7.* is outdated, as we switched to named stores with modelVersion-8.
    #
    # purpose: allow webpackages access on the root store
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/(_design|[a-z0-9]+)+ {
    #return 102;
        # cors related config
        add_header Access-Control-Allow-Headers "X-Requested-With";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Origin "*";

        # authentication
        limit_except GET HEAD {
            deny  all;
        }
        # proxy target
        rewrite ^/(.*)$ /webpackage-store/$1 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    #
    ###########################
    ### deprecated: end #######
    ###########################

    # purpose: fallback, if not other rule matches
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ /(.*) {
        return 200 'Cubixx. The platform for modular client-side webapps.';
        add_header Content-Type text/plain;
    }
}