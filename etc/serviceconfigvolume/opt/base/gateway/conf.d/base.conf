server {
    listen 80 default_server;
    server_name  _;

    ### ssl begin
    listen 443 ssl;
    #ssl_certificate ...will be replaced by docker-entrypoint.sh;
    #ssl_certificate_key ...will be replaced by docker-entrypoint.sh;
    ### ssl end

    # To find out, how nginx does request-proccessin: @see http://nginx.org/en/docs/http/request_processing.html

    # purpose: allow accessing webpackages directly
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location / {
        # cors related config
        add_header Access-Control-Allow-Headers "X-Requested-With";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Origin "*";

        # authentication
        limit_except GET HEAD {
            deny  all;
        }
        # proxy target
        proxy_pass http://coredatastore:5984/webpackage-store/;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }


    # purpose: allow upload webpackages directly
    # - couchdb-api details
    #   see http://docs.couchdb.org/en/1.6.1/http-api.html
    #   see https://wiki.apache.org/couchdb/HTTP_Document_API#Multiple_Attachments
    location ~ ^/(_upload|_api/upload) {
        # increase max file size from default=1mb
        # @see https://webbles.instajira.com/browse/PLAT-100
        client_max_body_size 2m;

        # CORS related config
        add_header Access-Control-Allow-Headers "X-Requested-With";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS, POST";
        add_header Access-Control-Allow-Origin "*";

        if ($request_method = OPTIONS ) {
            add_header Access-Control-Allow-Headers "Authorization";
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 200;
        }

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_upload-htpasswd;

        # proxy target
        rewrite ^/(_upload|_api/upload)(.*)$ /webpackage-store$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # purpose: allow replication of the database
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location ~ ^/(_replicate|_api/replicate) {
        # couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html

        # authentication
        auth_basic "Restricted";
        auth_basic_user_file /opt/base/gateway/conf.d/_replicate-htpasswd;

        # proxy target
        rewrite ^/(_replicate|_api/replicate)/?$ /webpackage-store break;
        rewrite ^/(_replicate|_api/replicate)/_changes$ /webpackage-store/_changes break;
        rewrite ^/(_replicate|_api/replicate)/_ensure_full_commit$ /webpackage-store/_ensure_full_commit break;
        rewrite ^/(_replicate|_api/replicate)(/.*)$ /webpackage-store$2 break;
        proxy_pass http://coredatastore:5984;

        # base64 encoded credentials (used https://www.base64encode.org/)
        proxy_set_header Authorization "Basic YWRtaW46YWRtaW4=";
        proxy_redirect off;
        proxy_buffering off;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # purpose: allow accessing webpackages directly
    # - couchdb-api details see http://docs.couchdb.org/en/1.6.1/http-api.html
    location /_api/webpackagesearch {
        # CORS
        #  note: LoopBack enables Cross-origin resource sharing (CORS).
        #  @see http://docs.strongloop.com/display/public/LB/Security+considerations#Securityconsiderations-CORS
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # limit access
        limit_except GET HEAD {
            deny  all;
        }
        # proxy target
        proxy_pass http://webpackagesearch:3000;
    }
}